{% extends "Admin/edit.html.twig" %}

{# override javascript includes #}
{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/fosjsrouting/js/router.min.js') }}"></script>
    <script src="{{ path('fos_js_routing_js', {callback: 'fos.Router.setData'}) }}"></script>
    <script type="text/javascript">
        jQuery(document).ready(function() {
            let workOrderNode = jQuery('#sonata-ba-field-container-{{ form.workOrder.vars.id }}');
            let won = jQuery('#{{ form.workOrder.vars.id }}');
            won.on('select2:select', function (e) {
                console.log('won select2:select');
                console.log(e);
            });
            console.log(workOrderNode);
            workOrderNode.change(function(event) {
                let workOrderId = event.val;
                console.log(workOrderId, 'change');
                updateWindfarmNodeByWorkOrder(workOrderId);
            });
            {% if admin.id(object) %}
                {# edit mode #}
                {% if object.nonStandardUsedMaterials | length > 0 %}
                    jQuery('#field_widget_{{ form.nonStandardUsedMaterials.vars.id }}')[0].children[0].children[0].children[0].children[0].width = '5%';
                    jQuery('#field_widget_{{ form.nonStandardUsedMaterials.vars.id }}')[0].children[0].children[0].children[0].children[2].width = '5%';
                {% endif %}
            {% endif %}
        });
        function updateWindfarmNodeByWorkOrder(workOrderId) {
            let windfarmsNode = jQuery('#sonata-ba-field-container-{{ form.windfarm.vars.id }}');
            console.log('updateWindfarmNodeByWorkOrder', windfarmsNode);
            jQuery.get(Routing.generate('admin_app_workorder_getWindfarmsFromCustomerId', {id: workOrderId})).done(function (response) {
                let jsonResponse = jQuery.parseJSON(response);
                console.log(jsonResponse);
                let windfarmsNodeSelector = windfarmsNode[0].children[1].getElementsByTagName("select")[0];
                while (windfarmsNodeSelector.firstChild) {
                    windfarmsNodeSelector.removeChild(windfarmsNodeSelector.firstChild);
                }
                if (jsonResponse.data.length > 0) {
                    for (let i = 0; i < jsonResponse.data.length; i++) {
                        let option = document.createElement("option");
                        option.innerText = jsonResponse.data[i].name;
                        option.value = jsonResponse.data[i].id;
                        if (i === 0) {
                            option.selected = true;
                        }
                        windfarmsNodeSelector.appendChild(option);

                    }
                }
            });
        }
    </script>
{% endblock %}
